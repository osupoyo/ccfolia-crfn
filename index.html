<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="icon" href="/image/favicon.ico">
        <title>ã‚¯ãƒªãƒ•ã‚¡ãƒ³ãƒã‚§ãƒƒã‚¯</title>
    </head>
    <header>
        <h1>ã‚¯ãƒªãƒ•ã‚¡ãƒ³ãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«</h1>
        <h2>CCFOLIA only ver 1.2.1</h2>
    </header>
    <div class="body">
        <nav class="sideBar">
            <form id="uploadForm" enctype="multipart/form-data">
                <div id="upFileWrap">
                    <div id="inputFile">
                        <!-- ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
                        <p id="dropArea">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„<br>ã¾ãŸã¯</p>
    
                        <div id="inputFileWrap">
                            <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ -->
                            <input id="fileToUpload" type="file" name="fileToUpload" accept=".html">
                            <div id="btnInputFile"><span>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹</span></div>
                        </div>
                    </div>
                    <div id="playerFilter"></div>
                    <button id="copyButton" type="button" onclick="copyResults()" class="copyButton" style="display:none;">ã‚³ãƒ”ãƒ¼</button>
                </form>
            </nav>
            <div class="main">
                <p>RESULT</p>
                <div id="resultContainer" class="list"></div>
            </div>
        </div>
    
    

<script>
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ã®å–å¾—
var fileArea = document.getElementById('dropArea');

// input[type=file]ã®å–å¾—
var fileInput = document.getElementById('fileToUpload'); // ä¿®æ­£: idãŒ 'fileToUpload' ãªã®ã§ã“ã¡ã‚‰ã«å¤‰æ›´

// ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®å‡¦ç†
fileArea.addEventListener('dragover', function(e){
    e.preventDefault();
    fileArea.classList.add('dragover');
});

// ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®å‡¦ç†
fileArea.addEventListener('dragleave', function(e){
    e.preventDefault();
    fileArea.classList.remove('dragover');
});

// ãƒ‰ãƒ­ãƒƒãƒ—æ™‚ã®å‡¦ç†
fileArea.addEventListener('drop', function(e){
    e.preventDefault();
    fileArea.classList.remove('dragover');

    // ãƒ‰ãƒ­ãƒƒãƒ—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
    var files = e.dataTransfer.files;

    // å–å¾—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’input[type=file]ã¸
    fileInput.files = files;

    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«å—ã‘å–ã‚ŒãŸå ´åˆã«å‡¦ç†ã‚’å®Ÿè¡Œ
    if (files[0]) {
        readFile(files[0]);
    }
});

// input[type=file]ã«å¤‰æ›´ãŒã‚ã‚Œã°å®Ÿè¡Œ
fileInput.addEventListener('change', function(e){
    var file = e.target.files[0];

    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«å—ã‘å–ã‚ŒãŸå ´åˆã«å‡¦ç†ã‚’å®Ÿè¡Œ
    if (file) {
        readFile(file);
    }
}, false);

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
function readFile(file) {
    var reader = new FileReader();

    reader.onload = function(e) {
        var contents = e.target.result;
        processFileContents(contents); // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®å‡¦ç†ã‚’è¡Œã†é–¢æ•°ã‚’å‘¼ã³å‡ºã™
    };

    reader.readAsText(file);
}

    // æŠ€èƒ½ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹é–¢æ•°
    function processFileContents(contents) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(contents, 'text/html');
        var paragraphs = doc.getElementsByTagName('p');

        var data = {};
        var totalDiceCount = 0;
        var totalCriticalSuccessCount = 0;
        var totalFumbleCount = 0;

        for (var i = 0; i < paragraphs.length; i++) {
            var paragraph = paragraphs[i];
            var mainSpan = paragraph.getElementsByTagName('span')[0];
            var mainText = mainSpan.textContent.trim();
            
            if (mainText !== '[é›‘è«‡]' && mainText !== '[æƒ…å ±]') {
                var nameSpan = paragraph.getElementsByTagName('span')[1];
                var name = nameSpan.textContent.trim();
                
                var resultSpan = paragraph.getElementsByTagName('span')[2];
                var resultText = resultSpan.textContent.trim();
                var match = resultText.match(/ã€(.+?)ã€‘.*ï¼ (\d+)/);
                if (match) {
                    var skill = match[1];
                    var diceResult = parseInt(match[2]);
                    
                    if (!data[name]) {
                        data[name] = {
                            skill: skill, // æŠ€èƒ½
                            totalDiceCount: 0, // ç·ãƒ€ã‚¤ã‚¹æ•°
                            successCount: 0, // æˆåŠŸæ•°
                            specialCount: 0, // ã‚¹ãƒšã‚·ãƒ£ãƒ«æ•°
                            criticalSuccessCount: 0, // æ±ºå®šçš„æˆåŠŸæ•°
                            failureCount: 0, // å¤±æ•—æ•°
                            fumbleCount: 0, // è‡´å‘½çš„å¤±æ•—æ•°
                            criticalSuccessResults: {}, // æ±ºå®šçš„æˆåŠŸã®çµæœã‚’é…åˆ—ã«æ ¼ç´
                            fumbleResults:{} // è‡´å‘½çš„å¤±æ•—ã®çµæœã‚’é…åˆ—ã«æ ¼ç´
                        };
                    }
                    
                    data[name].totalDiceCount++;
                    totalDiceCount++;
                    
                    if (resultText.includes('æ±ºå®šçš„æˆåŠŸ/ã‚¹ãƒšã‚·ãƒ£ãƒ«')) {
                        data[name].specialCount++;
                        data[name].criticalSuccessCount++;
                        totalCriticalSuccessCount++;
                    } else if (resultText.includes('æ±ºå®šçš„æˆåŠŸ')) {
                        data[name].criticalSuccessCount++;
                        totalCriticalSuccessCount++;
                    } else if (resultText.includes('æˆåŠŸ')) {
                        data[name].successCount++;
                    } else if (resultText.includes('è‡´å‘½çš„å¤±æ•—')) {
                        data[name].fumbleCount++;
                        totalFumbleCount++;
                    } else if (resultText.includes('å¤±æ•—')) {
                        data[name].failureCount++;
                    }

                    // æ±ºå®šçš„æˆåŠŸã¨è‡´å‘½çš„å¤±æ•—ã®çµæœã‚’æ ¼ç´
                    if (resultText.includes('æ±ºå®šçš„æˆåŠŸ')) {
                        if (!data[name].criticalSuccessResults[skill]) {
                            data[name].criticalSuccessResults[skill] = [];
                        }
                        data[name].criticalSuccessResults[skill].push(diceResult);
                    } else if (resultText.includes('è‡´å‘½çš„å¤±æ•—')) {
                        if (!data[name].fumbleResults[skill]) {
                            data[name].fumbleResults[skill] = [];
                        }
                        data[name].fumbleResults[skill].push(diceResult);
                    }
                }
            }
        }
        
        // çµæœã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤º
        var resultContainer = document.getElementById('resultContainer');
        resultContainer.innerHTML = '';

        for (var name in data) {
            var result = data[name];
            
            var criticalsuccessRate = (result.criticalSuccessCount / result.totalDiceCount) * 100;
            var fumbleRate = (result.fumbleCount / result.totalDiceCount) * 100;
            
            var output = '<div id="result_' + name + '">';
            output += '<p class="name">ğŸ”» ' + name + '</p>';
            output += '<ul>';
            output += '<li><p class="total">ç·ãƒ€ã‚¤ã‚¹æ•°: ' + result.totalDiceCount + 'å›</p></li>';
            output += '<li><p class="critical">æ±ºå®šçš„æˆåŠŸ: ' + result.criticalSuccessCount + 'å›</p></li>';
            output += '<ul>';

            // æ±ºå®šçš„æˆåŠŸã®æŠ€èƒ½çµæœã‚’è¡¨ç¤º
            for (var skill in result.criticalSuccessResults) {
                output += '<li>ã€' + skill + 'ã€‘</li>';
                output += '<ul>';

                var skillValues = result.criticalSuccessResults[skill];
                for (var j = 0; j < skillValues.length; j++) {
                    output += '<li>ï¼ ' + skillValues[j] + '</li>';
                }

                output += '</ul>';
            }

            output += '</ul></li>';
            output += '<li><p class="fumble">è‡´å‘½çš„å¤±æ•—: ' + result.fumbleCount + 'å›</p>';
            output += '<ul>';

            // è‡´å‘½çš„å¤±æ•—ã®æŠ€èƒ½çµæœã‚’è¡¨ç¤º
            for (var skill in result.fumbleResults) {
                output += '<li>ã€' + skill + 'ã€‘</li>';
                output += '<ul>';

                var skillValues = result.fumbleResults[skill];
                for (var j = 0; j < skillValues.length; j++) {
                    output += '<li>ï¼ ' + skillValues[j] + '</li>';
                }

                output += '</ul>';
            }

            output += '</ul></li>';
            output += '<li><p class="critical">æ±ºå®šçš„æˆåŠŸç‡: ' + criticalsuccessRate.toFixed(2) + '%</p></li>';
            output += '<li><p class="fumble">è‡´å‘½çš„å¤±æ•—ç‡: ' + fumbleRate.toFixed(2) + '%</p></li>';
            output += '</ul></div>';

            resultContainer.innerHTML += output;
        }
        
        // navéƒ¨åˆ†ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å+ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤º
        var sideBar = document.querySelector('.sideBar');

        // navéƒ¨åˆ†ã‚’åˆæœŸåŒ–
        var navOutput = '<ul>';

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’ä¸€åº¦ã ã‘ãƒªã‚¹ãƒˆåŒ–
        for (var name in data) {
            navOutput += '<li><label><input type="checkbox" class="resultCheckbox" checked onchange="togglePlayerVisibility(\'' + name + '\')"> ' + name + '</label></li>';
        }

        navOutput += '<li><label><input type="checkbox" class="resultCheckbox" checked onchange="togglePlayerVisibility(\'' + 'ç·åˆçµæœ' + '\')"> ç·åˆçµæœ</label></li>';
        navOutput += '</ul>';

        var existingPlayerFilter = document.querySelector('#playerFilter');
        if (existingPlayerFilter) {
            existingPlayerFilter.innerHTML = navOutput;
        } else {
            var newPlayerFilter = document.createElement('div');
            newPlayerFilter.id = 'playerFilter';
            newPlayerFilter.innerHTML = navOutput;
            sideBar.appendChild(newPlayerFilter);
        }

        // ç·æ•°ã‚’è¡¨ç¤º
        var totalCriticalSuccessRate = (totalCriticalSuccessCount / totalDiceCount) * 100;
        var totalFumbleRate = (totalFumbleCount / totalDiceCount) * 100;

        var totalOutput = '<div id="result_ç·åˆçµæœ">';
        totalOutput += '<p class="name">ğŸ”» ç·åˆçµæœ</p>';
        totalOutput += '<ul>';
        totalOutput += '<li><p class="total">ç·ãƒ€ã‚¤ã‚¹æ•°: ' + totalDiceCount + 'å›</p></li>';
        totalOutput += '<li><p class="critical">æ±ºå®šçš„æˆåŠŸ: ' + totalCriticalSuccessCount + 'å›</p></li>';
        totalOutput += '<li><p class="fumble">è‡´å‘½çš„å¤±æ•—: ' + totalFumbleCount + 'å›</p></li>';
        totalOutput += '<li><p class="critical">æ±ºå®šçš„æˆåŠŸç‡: ' + totalCriticalSuccessRate.toFixed(2) + '%</p></li>';
        totalOutput += '<li><p class="fumble">è‡´å‘½çš„å¤±æ•—ç‡: ' + totalFumbleRate.toFixed(2) + '%</p></li>';
        totalOutput += '</ul></div>';

        resultContainer.innerHTML += totalOutput;

        // å…¨æ–‡ã‚³ãƒ”ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('copyButton').style.display = 'block';
    }

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµæœã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ¶å¾¡ã™ã‚‹é–¢æ•°
    function togglePlayerVisibility(name) {
        var playerDiv = document.getElementById('result_' + name);
        var checkbox = document.querySelector('input[type="checkbox"][onchange*="' + name + '"]');
        if (checkbox.checked) {
            playerDiv.style.display = 'block';
        } else {
            playerDiv.style.display = 'none';
        }
    }
    
    // çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹é–¢æ•°
    function copyResults() {
        var resultContainer = document.getElementById('resultContainer');
        var resultDivs = resultContainer.querySelectorAll('div'); // <div>å˜ä½ã§å–å¾—

        var textToCopy = '';

        // ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å–å¾—
        var checkboxes = document.querySelectorAll('.resultCheckbox:checked');
    
        // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã«å¯¾å¿œã™ã‚‹çµæœã‚’ã‚³ãƒ”ãƒ¼
        checkboxes.forEach(function(checkbox) {
            var playerName = checkbox.parentElement.textContent.trim(); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å–å¾—
            var playerDiv = document.getElementById('result_' + playerName); // ãã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çµæœã®<div>ã‚’å–å¾—
            
            if (playerDiv) {
                var playerText = playerDiv.innerText.trim();

                // ã€Œè‡´å‘½çš„å¤±æ•—ç‡ã€ã®ç›´å‰ã«æ”¹è¡Œã‚’è¿½åŠ 
                playerText = playerText.replace(/(è‡´å‘½çš„å¤±æ•—ç‡:.*)/, '\n$1');

                // ä¸è¦ãªæ”¹è¡Œã‚’å‰Šé™¤
                playerText = playerText.replace(/\n+/g, '\n');

                textToCopy += playerText + '\n' + '\n'; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµæœã‚’è¿½åŠ 
            }
        });
  

        if (textToCopy.trim() === '') {
            alert('ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ãŸçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        var tempTextarea = document.createElement('textarea');
        tempTextarea.value = textToCopy.trim(); // æœ€åˆã‚„æœ€å¾Œã®ä½™è¨ˆãªæ”¹è¡Œã‚’å‰Šé™¤
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextarea);
        alert("é¸æŠã—ãŸçµæœãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼");
    }
</script>
</html>
